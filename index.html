<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="chosen_v1.8.7/docsupport/style.css">
        <link rel="stylesheet" href="chosen_v1.8.7/docsupport/prism.css">
        <link rel="stylesheet" href="chosen_v1.8.7/chosen.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    </head>
<body class="bg-white">
  <div class="container">
    <form class="needs-validation" novalidate>
      <div class="formgroup">
        <label for="mealName">Meal name <span style="color:red"><strong>*</strong></span></span></label>
        <input name="input-mealName" class="form-control form-control-md" type="text" id="mealName" placeholder="Name of your meal" required>
        <div class="invalid-feedback">
          Please enter a meal name!
        </div>
        <div class="valid-feedback">
          Looks good!
        </div>
      </div>
      
      <div class="formgroup">
        
           <!--Make sure the form has the autocomplete function switched off:-->
        <table class="table table-borderless table-hover" id="dataTable">
          <thead>
            <th tyle="width: 10%" scope="col"><input type="checkbox" id="selectall" /></th>
            <th style="width: 75%" scope="col"><strong>Ingredient</strong></th>
            <th style="width: 15%" scope="col"><strong>Quantity (in g/ml)</strong></th>
          </thead>
          <tbody>

            <tr>
              <td><input type="checkbox" class="check">
              </td>
              <td>
                <select name="input-1[]"  style="height:200px" class="chosen_select_L" id="ingredient" required>
                  <option></option>
                </select>
                <div class="invalid-tooltip">
                  Please select a valid ingredient.
                </div>
              </td>
              <td>
                <input name="input-2[]" class="form-control form-control-sm" type="number" min="0.1" max="9999" step="0.01" class="chosen_text" required>
                <div class="valid-feedback">
                  Looks good!
                </div>
                <div class="invalid-feedback">
                  Please provide a valid quantity.
                </div>
              </td>
              </td>
            </tr>
          </tbody>
        </table>
        <small id="ingredientsHelpBlock" class="form-text text-muted">
          To remove ingredient(s), select the checkbox that contains the ingredient and click on 'Remove ingredients'
        </small>
      </div>
    </form>


  <p>
    <div class="row row cols-4">
      <div class="col"> <input class="btn btn-primary btn-md btn-block" type="button" value="Add ingredient" onClick="addRow('dataTable')" /></div>
      <div class="col">  <input type="button"  class="btn btn-danger btn-md btn-block" value="Remove ingredients" onClick="deleteRow('dataTable')" /></div>
      <div class="col"></div>
      <div class="col">   <input type="submit" id="calculate" class="btn btn-dark btn-md btn-block" value="Calculate" /></div>
    </div>
  </p>
  
  <div id="calculation" class="row row cols-3">
    <div class="col-md">
      <h2>Average health star rating</h2> </br>
      <h3 id="meal_hsr"> </h3> </br>
      <h4 id="meal_stars"> </h4>
    </div>
    <div class="col-md">
      <h2>Total energy</h2> </br>
      <h3 id="meal_energy"> </h3> </br>
      <h4>calories</h4>
    </div>
    <div class="col-md">
      <h2>Total greenhouse gas emissions emitted</h2>
      <h3 id="meal_ghg"> </h3> </br>
      <h4>kilograms</h4>
    </div>
  </div>
  <div id="calculation" class="row row cols-4">
    <div class="col-md">
      <span hidden id="HSRLocalCopy"></span>
    </div>
    <div class="col-md">
    </div>
    <div class="col-md">
    </div>
    <div class="col-md">
      <input type="submit" id="submitIngredient" class="btn btn-dark btn-md btn-block" value="Submit"  />
    </div>
  </div>


  <div id='searchResults' hidden></div>
<p id="testAPI" hidden>List</p>
  </div>



</div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!-- <script src="chosen_v1.8.7/docsupport/jquery-3.2.1.min.js" type="text/javascript"></script> -->
<script src="chosen_v1.8.7/chosen.jquery.js" type="text/javascript"></script><!----->
<script src="chosen_v1.8.7/docsupport/prism.js" type="text/javascript" charset="utf-8"></script><!----->
<script src="chosen_v1.8.7/docsupport/init.js" type="text/javascript" charset="utf-8"></script> <!----->
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

<script src="script.js"></script>
<script src="script2.js"></script>

<script>
    var json;
    var JsonTagName = [];
    var JsonTagId = [];
    var ingredientInput = '{"name": "","ingredients":[]}'
    var mealInput;
    var jsonInput = [];
    var HSROutput = [];
    document.getElementById('calculate').disabled = true;
    (function() {
      'use strict';
      window.addEventListener('load', function() {
        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        var forms = document.getElementsByClassName('needs-validation');
        document.getElementById('submitIngredient').disabled = true;
        // Loop over them and prevent submission
        var validation = Array.prototype.filter.call(forms, function(form) {
          document.getElementById('calculate').addEventListener('click', function(event) {
            if (form.checkValidity() === false) {         
              event.preventDefault();
              event.stopPropagation();
            }
            form.classList.add('was-validated');
            parseAsJson();
          }, false);
        });
      }, false);
    })();


    setTimeout(function(){
        json = JSON.parse(document.getElementById('testAPI').innerHTML);
        for(var i = 0; i < json.ingredients.length; i++) {
        var obj = json.ingredients[i];

        //console.log(obj.name);
        var tag = document.createElement("p");
        var text = document.createTextNode(obj.name + ', ' + obj.ingredient_type);
        var ingredientId = document.createTextNode(obj._id);
        tag.appendChild(text);
        var element = document.getElementById("searchResults");
        element.appendChild(tag);
        JsonTagName.push(text.data);
        JsonTagId.push(ingredientId.data)
        };
        for (var i = 0; i < JsonTagName.length; i++){
          var o = new Option(JsonTagName[i], JsonTagId[i]);
          $(o).html(JsonTagName[i]);
          $(".chosen_select_L").append(o);
          console.log("fetch")
        }
        $(".chosen_select_L").chosen('destroy');
        $(".chosen_select_L").chosen();
        document.getElementById('calculate').disabled = false;
    }, 3000);

    console.log("fetch OK");
    console.log("fetch done");




    $('.chosen_select_L').on('change', function(evt, params) {
      // The value
      console.log($(this).val());

    });


  

  function parseAsJson(){
    console.log(document.getElementById('mealName').value);
    mealInput = document.getElementById('mealName').value;
    ingredientInput = '{"name": "","ingredients":[]}'
    var obj = JSON.parse(ingredientInput);
    obj["name"] = mealInput;
    for (var i = 0; i < $('.chosen_select_L').length; i++){
      var ingredientId = $('.chosen_select_L')[i].value
      var quantity = document.getElementsByName('input-2[]')[i].value
      // ingredientInput.append(ingredientId, quantity)
      if (ingredientId != "" && typeof parseFloat(quantity) != "string" && parseFloat(quantity) <= 9999){
        obj["ingredients"].push({ingredientId, quantity});
      } else {
        obj["name"] = "";
        obj["ingredients"] = [];
      }
    }
    
    ingredientInput = JSON.stringify(obj);
    console.log (ingredientInput == '{"name":"","ingredients":[]}');
    if (ingredientInput == '{"name":"","ingredients":[]}'){
      document.getElementById('submitIngredient').disabled = true;
      console.log('true');
    } else {   
      console.log(ingredientInput);
      setTimeout(function(){
        calculate();
        document.getElementById('submitIngredient').disabled = false;
      },100);
    }
  }

  function getStars(rating) {

    // Round to nearest half
    rating = Math.round(rating * 2) / 2;
    let output = [];

    // Append all the filled whole stars
    for (var i = rating; i >= 1; i--)
    output.push('<i class="fa fa-star" aria-hidden="true" style="color: gold;"></i>&nbsp;');

    // If there is a half a star, append it
    if (i == .5) output.push('<i class="fa fa-star-half-o" aria-hidden="true" style="color: gold;"></i>&nbsp;');

    // Fill the empty stars
    for (let i = (5 - rating); i >= 1; i--)
    output.push('<i class="fa fa-star-o" aria-hidden="true" style="color: gold;"></i>&nbsp;');

    return output.join('');

  }

  function calculate(){
    console.log("Call ok");
    
    console.log(ingredientInput);
    var jsonIn = JSON.parse(ingredientInput);
    var jsonLength = jsonIn.ingredients.length;
    console.log(jsonLength);
    
    
    for(var i = -1; i < jsonLength - 1; i++){
      var ingreId = jsonIn.ingredients[i+1].ingredientId;
      console.log(ingreId);
      var cat_ID;
      var protein;
      var energy;
      var tsfa;
      var sugars;
      var sodium;
      var fibre;
      var ghg;

      var requestOptions = {
        method: 'GET',
        redirect: 'follow'
      };


      var url = "";
      url = url.concat("https://gfood-api.azurewebsites.net/ingredients/", ingreId);
      console.log(url);

      var localCopy;
      var requestOptions = {
        method: 'GET',
        redirect: 'follow'
      };
      

      fetch(url, requestOptions)
        .then(response => response.text())
        .then(data => localCopy = data)
        .then(() =>  jsonInput.push(localCopy))
        .catch(error => console.log('error', error));
      
      // console.log("OK" + localCopy)
      // jsonInput.push(localCopy);
      console.log(i);
      setTimeout(function(){
          console.log(jsonInput);
          var inputProccess;
          console.log('index: ' + i);
          console.log(jsonInput[i]);
          inputProccess = jsonInput[i];
          inputProccess = JSON.parse(inputProccess);
          console.log('INPUT PROCESS:'+inputProccess);


          cat_ID = "2";
          protein = parseFloat(inputProccess.protein);
          energy = parseFloat(inputProccess.energy);
          tsfa = parseFloat(inputProccess.saturated_fat);
          sugars = parseFloat(inputProccess.sugar);
          sodium = parseFloat(inputProccess.sodium);
          fibre = parseFloat(inputProccess.fibre);

          var n = 5;
          var myHeaders2 = new Headers();

          var whyTheHell;

          myHeaders2.append("Content-Type", "application/json");
          myHeaders2.append('Accept', 'application/json');
          myHeaders2.append('GET', 'POST');

          raw = JSON.stringify({"category_id":cat_ID,"energy":energy,"tsfa":tsfa,"sugars":sugars,"sodium":sodium,"protein":protein,"fibre":fibre});
          console.log(raw);

          var requestOptions = {
            method: 'POST',
            headers: myHeaders2,
            body: raw,
            redirect: 'follow'
          };
          console.log(requestOptions);
          //document.getElementById('myText').innerHTML = '<img src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif" height=20% width=20% />';
          // const fetch_retry = async (n) => {
            setTimeout(function(){
              console.log('Starting HSR API');
            //try {
              var localHSR;
              fetch("https://gfood-hsr-api.azurewebsites.net", requestOptions)
              .then(response => response.text())
              .then(data =>  localHSR = data)
              .then(() => HSROutput.push(parseFloat(localHSR.substring(7, 10))))
              .catch(error => console.log('error', error));

              fetch("https://gfood-hsr-api.azurewebsites.net", requestOptions)
              .then(response => response.text())
              .then(data =>  localHSR = data)
              .then(() => document.getElementById("meal_stars").innerHTML = getStars(parseFloat(localHSR.substring(7,10))))
              .catch(error => console.log('error', error));
              console.log("fetch ok");
              //console.log(typeof whyTheHell);

              //HSROutput.push(parseFloat(whyTheHell.substring(7, 10))); 
            },500)
           
              

          //   } catch(err) {
          //    if (n === 1) throw err;
          //    return await fetch_retry(n - 1);
          //  }
          // };
      }, 3000)
    

    }
    setTimeout(function(){
      var hsrSum = 0;
      console.log(hsrSum);
      for( var i = 0; i < HSROutput.length; i++ ){
        hsrSum += (HSROutput[i]); //don't forget to add the base
      }
      var avg = parseFloat(hsrSum/HSROutput.length);
      console.log(hsrSum);
      console.log(avg);
      document.getElementById('meal_hsr').innerHTML = avg;
    },5500)

  }

  

</script>



</html>
