<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="chosen_v1.8.7/docsupport/style.css">
        <link rel="stylesheet" href="chosen_v1.8.7/docsupport/prism.css">
        <link rel="stylesheet" href="chosen_v1.8.7/chosen.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
      <style>
        .spanner{
  position:absolute;
  top: 50%;
  left: 0;
  background: rgba(0,0,0,0.5);;
  width: 100%;
  height: 100%;
  display:block;
  text-align:center;
  height: 300px;
  color: #FFF;
  transform: translateY(-50%);
  z-index: 1000;
  visibility: hidden;
}

.overlay{
  position: fixed;
	width: 100%;
	height: 100%;
  background: rgba(0,0,0,0.5);
  visibility: hidden;
  z-index: 2;
}

.loader,
.loader:before,
.loader:after {
  border-radius: 50%;
  width: 2.5em;
  height: 2.5em;
  -webkit-animation-fill-mode: both;
  animation-fill-mode: both;
  -webkit-animation: load7 1.8s infinite ease-in-out;
  animation: load7 1.8s infinite ease-in-out;
  
}
.loader {
  color: #ffffff;
  font-size: 10px;
  margin: 25% auto;
  position: relative;
  text-indent: -9999em;

  -webkit-transform: translateZ(0);
  -ms-transform: translateZ(0);
  transform: translateZ(0);
  -webkit-animation-delay: -0.16s;
  animation-delay: -0.16s;
}
.loader:before,
.loader:after {
  content: '';
  position: absolute;
  top: 0;
}
.loader:before {
  left: -3.5em;
  -webkit-animation-delay: -0.32s;
  animation-delay: -0.32s;
}
.loader:after {
  left: 3.5em;
}
@-webkit-keyframes load7 {
  0%,
  80%,
  100% {
    box-shadow: 0 2.5em 0 -1.3em;
  }
  40% {
    box-shadow: 0 2.5em 0 0;
  }
}
@keyframes load7 {
  0%,
  80%,
  100% {
    box-shadow: 0 2.5em 0 -1.3em;
  }
  40% {
    box-shadow: 0 2.5em 0 0;
  }
}

.show{
  visibility: visible;
}

.spanner, .overlay{
	opacity: 0;
	-webkit-transition: all 0.3s;
	-moz-transition: all 0.3s;
	transition: all 0.3s;
}

.spanner.show, .overlay.show {
	opacity: 1;
  width: 100%;
  height: 100%;
  align-content: center;
}
      </style>
      <script src="https://kit.fontawesome.com/4bc50e910c.js" crossorigin="anonymous"></script>
    </head>
<body class="bg-white">
    <div class="overlay"></div>
  <div class="spanner">
    <div class="loader"></div>
  </div>
  <div class="container">
    <form class="needs-validation" novalidate>
      <h2 class="p-2"> Meal information </h2>
      <div class="formgroup p-5" >
        <label for="mealName"><strong>Meal name </strong> <span style="color:red"><strong>*</strong></span></span> <i class="fas fa-info-circle" id="nameHelp" data-toggle="tooltip" data-placement="right" title="Your desired meal name"></i></label>
        <input name="input-mealName" class="form-control form-control-md" type="text" id="mealName" placeholder="Name of your meal" required>
        <div class="invalid-feedback">
          Please enter a meal name!
        </div>
        <div class="valid-feedback">
          Looks good!
        </div>
      </div>

      <div class="formgroup p-5">
        <label for="mealDescription"> <strong>Meal description <i class="fas fa-info-circle" id="descHelp" data-toggle="tooltip" data-placement="right" title="Your meal description (optional)"></i></strong> </span></span></label>
        <textarea name="input-mealDesc" class="form-control form-control-md" type="textarea" id="mealDescription" placeholder="Description here" rows = "3"></textarea>
      </div >
      
      <div class = "row row cols-4">
        <div class="col"><h2> Ingredients </h2><span>(Max 15)</div>
        <div class="col"></div>
        <div class="col">
          <small id="ingredientsHelpBlock" class="form-text text-muted">
            Ingredient not found? Add a new ingredient using this button (opens in a new window)
          </small>
        </div>
        <div class="col"><a href="https://www.gfood.gq/add-ingredient/" target="_blank" class = "btn btn-md btn-success" data-toggle="tooltip" data-placement="top" title="Open in a new window">New ingredient</a></div>
        
      </div>
      
      <div class="formgroup p-5">
        <h5>Count: <span id="ingreCounter">1</span>/15</h5>
           <!--Make sure the form has the autocomplete function switched off:-->
        <table class="table table-borderless table-hover" id="dataTable">
          <thead>
            <th tyle="width: 15%" scope="col"><input type="checkbox" id="selectall" /> <i class="fas fa-info-circle" id="deleteHelp" data-toggle="tooltip" data-placement="top" title="Select all ingredients"></i></th>
            <th style="width: 65%" scope="col"><strong>Ingredient <i class="fas fa-info-circle" id="ingreHelp" data-toggle="tooltip" data-placement="top" title="The ingredients in your specified meal"></i></strong></th>
            <th style="width: 20%" scope="col"><strong>Quantity (g/ml) <i class="fas fa-info-circle" id="quantityHelp" data-toggle="tooltip" data-placement="top" title="Approximate quantity of each ingredient (in either grams or mililitres"></i></strong></th>
          </thead>
          <tbody>

            <tr>
              <td><input type="checkbox" class="check">
              </td>
              <td>
                <select name="input-1[]" class="chosen_select_L" id="ingredient" required>
                  <option></option>
                </select>
                <div class="invalid-tooltip">
                  Please select a valid ingredient.
                </div>
              </td>
              <td>
                <input name="input-2[]" class="form-control form-control-sm" type="number" min="0.1" max="9999" step="0.01" class="chosen_text" required>
                <div class="valid-feedback">
                  Looks good!
                </div>
                <div class="invalid-feedback">
                  Please provide a valid quantity (from 0 to 9999)
                </div>
              </td>
              </td>
            </tr>
          </tbody>
        </table>
        <small id="ingredientsHelpBlock" class="form-text text-muted">
          <span style="color:red;"> <strong>*</strong></span> To remove ingredient(s), select the checkbox that contains the ingredient and click on 'Remove ingredients'
        </small>
        <small id="ingredientsHelpBlock" class="form-text text-muted">
          <span style="color:red;"> <strong>*</strong></span> Maximum ingredient quantity: 9999 g/ml
        </small>
      </div>
    </form>


  <p>
    <div class="row row cols-4">
      <div class="col"> <input id="addRow" class="btn btn-primary btn-md btn-block" type="button" value="Add ingredient" onClick="addRow('dataTable')" /></div>
      <div class="col">  <input id="deleteRow" type="button"  class="btn btn-danger btn-md btn-block" value="Remove ingredients" onClick="deleteRow('dataTable')" /></div>
      <div class="col"></div>
      <div class="col">   <input type="submit" id="calculate" class="btn btn-dark btn-md btn-block" value="Calculate information" /></div>
    </div>
  </p>

</br>
  <div class="row"></div>
  <h2 id ="mealInfo" hidden>Your meal information</h2>
  <div id="calculation" class="row row cols-3 p-5">
    <div class="col-md">
      <h4 id="hsrLabel1" hidden>Average health star rating</h4>
      <h2 id="meal_hsr"> </h2> 
      <div id="hsrLabel" hidden><span id="stars"></span></div>
    </div>
    <div class="col-md">
      <h4 id="energyLabel1" hidden>Energy</h4> 
      <h2 id="meal_energy"> </h2> 
      <h4 id="energyLabel" hidden>calories</h4>
    </div>
    <div class="col-md">
      <h5 id="ghgLabel1" hidden>Greenhouse gas emitted</h5>
      <h2 id="meal_ghg"> </h2> 
      <h4 id="ghgLabel" hidden>kilograms of Carbondioxide</h4>
    </div>
  </div>


  <div id="calculation" class="row row cols-4">
    <div class="col-md">
      <span hidden id="HSRLocalCopy"></span>
    </div>
    <div class="col-md">
    </div>
    <div class="col-md">
    </div>
    <div class="col-md">
      <input type="submit" id="submitIngredient" class="btn btn-success btn-lg btn-block" value="Submit Meal" onClick="SubmitMeal()" />
    </div>
  </div>


  <div id='searchResults' hidden></div>
<p id="testAPI" hidden>List</p>
  </div>



</div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!-- <script src="chosen_v1.8.7/docsupport/jquery-3.2.1.min.js" type="text/javascript"></script> -->
<script src="chosen_v1.8.7/chosen.jquery.js" type="text/javascript"></script><!----->
<script src="chosen_v1.8.7/docsupport/prism.js" type="text/javascript" charset="utf-8"></script><!----->
<script src="chosen_v1.8.7/docsupport/init.js" type="text/javascript" charset="utf-8"></script> <!----->
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

<script src="script.js"></script>
<script src="script2.js"></script>

<script>
    var json;
    var JsonTagName = [];
    var JsonTagId = [];
    var ingredientInput = '{"name": "", "description": "","ingredients":[]}'
    var mealInput;
    var jsonInput = [];
    var HSROutput = [];
    var ingreMeasure = [];
    var energyOutput = [];
    var ghgOutput = [];
    document.getElementById('calculate').disabled = true;
    (function() {
      'use strict';
      window.addEventListener('load', function() {
        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        var forms = document.getElementsByClassName('needs-validation');
        $("div.spanner").addClass("show");
        $("div.overlay").addClass("show");
        
        
        setTimeout(function(){
            $("div.spanner").removeClass("show");
            $("div.overlay").removeClass("show");
        
        }, 4000)
        document.getElementById('deleteRow').disabled = true;
        document.getElementById('submitIngredient').disabled = true;
        document.getElementById('submitIngredient').hidden = true;
        // Loop over them and prevent submission
        var validation = Array.prototype.filter.call(forms, function(form) {
          document.getElementById('calculate').addEventListener('click', function(event) {
            if (form.checkValidity() === false) {         
              event.preventDefault();
              event.stopPropagation();
            }
            form.classList.add('was-validated');
            parseAsJson();
          }, false);
        });
      }, false);
    })();


    setTimeout(function(){
        json = JSON.parse(document.getElementById('testAPI').innerHTML);
        for(var i = 0; i < json.ingredients.length; i++) {
        var obj = json.ingredients[i];

        //console.log(obj.name);
        var tag = document.createElement("p");
        var text = document.createTextNode(obj.name + ', ' + obj.ingredient_type);
        var ingredientId = document.createTextNode(obj._id);
        tag.appendChild(text);
        var element = document.getElementById("searchResults");
        element.appendChild(tag);
        JsonTagName.push(text.data);
        JsonTagId.push(ingredientId.data)
        };
        for (var i = 0; i < JsonTagName.length; i++){
          var o = new Option(JsonTagName[i], JsonTagId[i]);
          $(o).html(JsonTagName[i]);
          $(".chosen_select_L").append(o);
          console.log("fetch")
        }
        $(".chosen_select_L").chosen('destroy');
        $(".chosen_select_L").chosen();
        document.getElementById('calculate').disabled = false;
    }, 3000);

    console.log("fetch OK");
    console.log("fetch done");




    $('.chosen_select_L').on('change', function(evt, params) {
      // The value
      console.log($(this).val());

    });


  

  function parseAsJson(){
    console.log(document.getElementById('mealName').value);
    mealInput = document.getElementById('mealName').value;
    mealDesc = document.getElementById('mealDescription').value;
    ingredientInput = '{"name": "","description":"","ingredients":[]}'
    var obj = JSON.parse(ingredientInput);
    obj["name"] = mealInput;
    obj["description"] = mealDesc;
    for (var i = 0; i < $('.chosen_select_L').length; i++){
      var ingredientId = $('.chosen_select_L')[i].value
      var quantity = document.getElementsByName('input-2[]')[i].value
      // ingredientInput.append(ingredientId, quantity)
      if (ingredientId != "" && typeof parseFloat(quantity) != "string" && parseFloat(quantity) <= 9999 && parseFloat(quantity) > 0){
        obj["ingredients"].push({ingredientId, quantity});
      } else {
        obj["name"] = "";
        obj["description"] = "";
        obj["ingredients"] = [];
      }
    }
    
    ingredientInput = JSON.stringify(obj);
    console.log (ingredientInput == '{"name":"","description":"","ingredients":[]}');
    if (ingredientInput == '{"name":"","description":"","ingredients":[]}'){
      document.getElementById('submitIngredient').disabled = true;
      console.log('true');
    } else {   
      console.log(ingredientInput);
      setTimeout(function(){
        calculate();
        document.getElementById('submitIngredient').disabled = false;
      },100);
    }
  }

  function getStars(rating) {

    // Round to nearest half
    rating = Math.round(rating * 2) / 2;
    let output = [];

    // Append all the filled whole stars
    for (var i = rating; i >= 1; i--)
    output.push('<i class="fa fa-star" aria-hidden="true" style="color: gold;"></i>&nbsp;');

    // If there is a half a star, append it
    if (i == .5) output.push('<i class="fa fa-star-half-o" aria-hidden="true" style="color: gold;"></i>&nbsp;');

    // Fill the empty stars
    for (let i = (5 - rating); i >= 1; i--)
    output.push('<i class="fa fa-star-o" aria-hidden="true" style="color: gold;"></i>&nbsp;');

    return output.join('');

  }

  function calculate(){
    document.getElementById('submitIngredient').hidden = false;
    document.getElementById('mealInfo').hidden = true;
    document.getElementById('hsrLabel').hidden = true;
    document.getElementById('energyLabel').hidden = true;
    document.getElementById('ghgLabel').hidden = true;

    document.getElementById('hsrLabel1').hidden = true;
    document.getElementById('energyLabel1').hidden = true;
    document.getElementById('ghgLabel1').hidden = true;

    document.getElementById('meal_hsr').innerHTML = '<img src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif" height=20% width=20% />';
    document.getElementById('meal_energy').innerHTML = '<img src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif" height=20% width=20% />';
    document.getElementById('meal_ghg').innerHTML =  '<img src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif" height=20% width=20% />';


    console.log("Call ok");
    
    console.log(ingredientInput);
    var jsonIn = JSON.parse(ingredientInput);
    var jsonLength = jsonIn.ingredients.length;
    console.log(jsonLength);

    
    for(var i = -1; i < jsonLength - 1; i++){
      var ingreId = jsonIn.ingredients[i+1].ingredientId;
      console.log("this is the id: " + ingreId);

      
      ingreMeasure.push(parseFloat(jsonIn.ingredients[i + 1].quantity));

      console.log(ingreId);
      var cat_ID;
      var class_ID;
      var protein;
      var energy;
      var tsfa;
      var sugars;
      var sodium;
      var fibre;
      var ghg;

      var requestOptions = {
        method: 'GET',
        redirect: 'follow'
      };


      var url = "";
      url = url.concat("https://gfood-api.azurewebsites.net/ingredients/", ingreId);
      console.log(url);

      var localCopy;
      var requestOptions = {
        method: 'GET',
        redirect: 'follow'
      };
      

      fetch(url, requestOptions)
        .then(response => response.text())
        .then(data => localCopy = data)
        .then(() =>  jsonInput.push(localCopy))
        .catch(error => console.log('error', error));
      
      // console.log("OK" + localCopy)
      // jsonInput.push(localCopy);
      console.log(i);
      setTimeout(function(){
          console.log(jsonInput);
          var inputProccess;
          console.log('index: ' + i);
          console.log(jsonInput[i]);
          inputProccess = jsonInput[i];
          inputProccess = JSON.parse(inputProccess);
          console.log('INPUT PROCESS:'+inputProccess);

          if(!inputProccess.hsr_id){
            cat_ID = (Math.floor(Math.random() * 3) + 1).toString();
            if(Math.round(Math.random()) == 1){
              cat_ID = cat_ID + "D";
            }
          } else {
            cat_ID = parseFloat(inputProccess.hsr_id);
          }
          if(!inputProccess.emission_id){
            class_ID = Math.floor(Math.random() * 44) + 1; 
          } else {
            class_ID = parseFloat(inputProccess.emission_id);
          }
          ghgOutput.push(parseFloat(ghgEmissions(parseInt(class_ID))));

          protein = parseFloat(inputProccess.protein);


          energy = parseFloat(inputProccess.energy);
          energyOutput.push(energy);
          

          tsfa = parseFloat(inputProccess.saturated_fat);
          sugars = parseFloat(inputProccess.sugar);
          sodium = parseFloat(inputProccess.sodium);
          fibre = parseFloat(inputProccess.fibre);

          var n = 5;
          var myHeaders2 = new Headers();

          var whyTheHell;

          myHeaders2.append("Content-Type", "application/json");
          myHeaders2.append('Accept', 'application/json');
          myHeaders2.append('GET', 'POST');

          raw = JSON.stringify({"category_id":cat_ID,"energy":energy,"tsfa":tsfa,"sugars":sugars,"sodium":sodium,"protein":protein,"fibre":fibre});
          console.log(raw);

          var requestOptions = {
            method: 'POST',
            headers: myHeaders2,
            body: raw,
            redirect: 'follow'
          };
          console.log(requestOptions);
          //document.getElementById('myText').innerHTML = '<img src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif" height=20% width=20% />';
          // const fetch_retry = async (n) => {
            setTimeout(function(){
              console.log('Starting HSR API');
            //try {
              var localHSR;
              fetch("https://gfood-hsr-api.azurewebsites.net", requestOptions)
              .then(response => response.text())
              .then(data =>  localHSR = data)
              .then(() => HSROutput.push(parseFloat(localHSR.substring(7, 10))))
              .catch(error => console.log('error', error));

              // fetch("https://gfood-hsr-api.azurewebsites.net", requestOptions)
              // .then(response => response.text())
              // .then(data =>  localHSR = data)
              // .then(() => )
              // .catch(error => console.log('error', error));
              console.log("fetch ok");
              //console.log(typeof whyTheHell);

              //HSROutput.push(parseFloat(whyTheHell.substring(7, 10))); 
            },500)
           
              

          //   } catch(err) {
          //    if (n === 1) throw err;
          //    return await fetch_retry(n - 1);
          //  }
          // };
      }, 2000)
      

    }
    setTimeout(function(){
      var hsrSum = 0;
      var energySum = 0;
      var ghgSum = 0;
      // console.log(hsrSum);
      for( var i = 0; i < HSROutput.length; i++ ){
        hsrSum += (HSROutput[i]); //don't forget to add the base
        energySum += parseFloat(energyOutput[i]/ 100 * ingreMeasure[i]);
        ghgSum += parseFloat(ghgOutput[i]/ 100 * ingreMeasure[i]);
      }
      var avg = Math.round(parseFloat(hsrSum/HSROutput.length),2);
      console.log(hsrSum);
      console.log(avg);
      document.getElementById('mealInfo').hidden = false;
      document.getElementById('hsrLabel1').hidden = false;
      document.getElementById('energyLabel1').hidden = false;
      document.getElementById('ghgLabel1').hidden = false;
      document.getElementById('hsrLabel').hidden = false;
      document.getElementById('energyLabel').hidden = false;
      document.getElementById('ghgLabel').hidden = false;
      document.getElementById('meal_hsr').innerHTML = avg;
      document.getElementById('stars').innerHTML = getStars(avg);
      document.getElementById('meal_energy').innerHTML = Math.round(energySum,2);
      document.getElementById('meal_ghg').innerHTML = Math.round(ghgSum,2);
      window.scrollTo(0,document.body.scrollHeight);
    },3500)
    
  }

  function SubmitMeal(){
    $("div.spanner").addClass("show");
    $("div.overlay").addClass("show");
        
        
    setTimeout(function(){
        $("div.spanner").removeClass("show");
        $("div.overlay").removeClass("show");
    
    }, 4000)

    var myHeaders = new Headers();
    myHeaders.append("Content-Type", "application/json");
    myHeaders.append('Accept', 'application/json');
    myHeaders.append('GET', 'POST');

    ingredientInput = JSON.parse(ingredientInput);
    ingredientInput["hsr"] = parseFloat(document.getElementById('meal_hsr').innerHTML)
    ingredientInput["energy"] = parseFloat(document.getElementById('meal_energy').innerHTML)
    ingredientInput["ghg"] = parseFloat(document.getElementById('meal_ghg').innerHTML)

    var raw = JSON.stringify(ingredientInput);
    console.log(ingredientInput);

    var requestOptions = {
      method: 'POST',
      headers: myHeaders,
      body: raw,
      redirect: 'follow'
    };

    fetch("https://gfood-api.azurewebsites.net/meals/add", requestOptions)
      .then(response => response.text())
      .then(result => console.log(result))
      .catch(error => console.log('error', error));

      window.top.location.href = "http://www.gfood.gq/thank-you/"; 
  }

  function ghgEmissions(catId){
    switch(catId){
      case 1 : return 1.58 ; break;
      case 2 : return 1.68 ; break;
      case 3 : return 1.18 ; break;
      case 4 : return 2.47 ; break;
      case 5 : return 3.81 ; break;
      case 6 : return 0.45 ; break;
      case 7 : return 1.3 ; break;
      case 8 : return 3.16 ; break;
      case 9 : return 1.8 ; break;
      case 10 : return 1.79 ; break;
      case 11 : return 0.97 ; break;
      case 12 : return 0.37 ; break;
      case 13 : return 3.18 ; break;
      case 14 : return 0.97 ; break;
      case 15 : return 3.14 ; break;
      case 16 : return 6.15 ; break;
      case 17 : return 7.16 ; break;
      case 18 : return 3.59 ; break;
      case 19 : return 3.76 ; break;
      case 20 : return 5.25 ; break;
      case 21 : return 2.01 ; break;
      case 22 : return 0.5 ; break;
      case 23 : return 0.43 ; break;
      case 24 : return 0.51 ; break;
      case 25 : return 0.53 ; break;
      case 26 : return 0.37 ; break;
      case 27 : return 0.86 ; break;
      case 28 : return 0.42 ; break;
      case 29 : return 1.52 ; break;
      case 30 : return 1.76 ; break;
      case 31 : return 1.06 ; break;
      case 32 : return 27.65 ; break;
      case 33 : return 46.28 ; break;
      case 34 : return 85.19 ; break;
      case 35 : return 28.79 ; break;
      case 36 : return 32.71 ; break;
      case 37 : return 11.54 ; break;
      case 38 : return 9.82 ; break;
      case 39 : return 2.84 ; break;
      case 40 : return 21.44 ; break;
      case 41 : return 4.6 ; break;
      case 42 : return 12.51 ; break;
      case 43 : return 23.99 ; break;
      default  : return 1;  
    }
  }

  

</script>



</html>
